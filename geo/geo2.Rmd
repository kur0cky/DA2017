---
title: "geo2"
author: "Yutaka Kuroki"
date: "2018年2月5日"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# library

```{r}
library(tidyverse)
library(lubridate)
```

# 使用データ

- geo_customer.csv
- station.csv
- ken_all
- line
- route

```{r}
geo_customer <- read_csv("data/geo_customer.csv")
station <- read_csv("data/station20171109free.csv")
ken_all <- read.csv("data/ken_all.csv", fileEncoding = "shift-jis", stringsAsFactors = FALSE) %>% 
  as_tibble()
```

```{r}
station
ken_all %>% as_tibble()



```

# 関東圏に絞る

```{r}
station <- station %>% 
  as_tibble() %>% 
  mutate(zipcode = as.integer(str_replace(post,"-",""))) %>% 
  left_join(ken_all, by = "zipcode") %>% 
  filter(l == "東京都"|
           l == "神奈川県"|
           l == "埼玉県"|
           l == "千葉県"|
           l == "栃木県"|
           l == "茨城県"|
           l == "群馬県") %>% 
  select(station_cd, station_g_cd, station_name, line_cd, zipcode, l, m, s, lon, lat)
```

```{r}
geo_customer <- geo_customer %>% 
  left_join(ken_all, by = "zipcode") %>% 
  filter(l == "東京都"|
           l == "神奈川県"|
           l == "埼玉県"|
           l == "千葉県"|
           l == "栃木県"|
           l == "茨城県"|
           l == "群馬県") %>% 
  select(customer_id, zipcode, lon, lat, l, m, s, repeater)
```



```{r}
tmp <- geo_customer %>%
  mutate(a = 1) %>% 
  left_join(station %>% mutate(a=1) %>% select(-l, -m, -s) , by = "a")

tmp2 <- tmp %>% 
  mutate(dist = sqrt((lon.x-lon.y)^2 + (lat.x-lat.y)^2)) %>% 
  group_by(customer_id) %>% 
  filter(dist == min(dist)) %>% 
  select(customer_id, zipcode = zipcode.x, lon = lon.x, lat = lat.x, station_cd, station_name, line_cd, l, m, s, dist, repeater) %>% 
  left_join(route %>% select(line_cd, line_name), by = "line_cd") %>% 
  arrange(customer_id) %>% 
  select(customer_id, zipcode, lon, lat, station_cd, station_name, line_name, line_cd, l, m, s, dist, repeater)

tmp2 %>% 
  write_csv("data/station_customer.csv")

```

```{r}
tmp2 <- tmp2 %>% group_by(customer_id, l, m, station_name, repeater) %>% summarise()
tmp3 <- line %>% 
  left_join(product %>% select(-in_tax), by = "product_id") %>% 
  left_join(tmp2, by = "customer_id") %>% 
  select(category_1, category_id_1, station_name, l, m, in_tax, repeater)

tmp3 %>% 
  group_by(category_1, l) %>% 
  summarise(sales = sum(in_tax)) %>% 
  ggplot(aes(category_1, sales))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  facet_wrap(~l, scale="free")

tmp4 <- tmp3 %>% 
  filter(m == "世田谷区"|m=="葛飾区"| m=="渋谷区") %>% 
  group_by(category_1, m, repeater) %>% 
  summarise(sales = sum(in_tax)) %>% 
  spread(m,sales) 
tmp4[is.na(tmp4)] <- 0
tmp4 %>% 
  gather(m,sales,-category_1, -repeater) %>% 
  ggplot(aes(category_1, sales, group=m, fill=repeater))+
  geom_bar(stat="identity")+
  facet_wrap(~m, scale="free")
```

